#!/usr/bin/env node

const nodemailer = require('nodemailer');
require('dotenv').config({ path: '.env.local' });

async function testEmailService() {
  console.log('üß™ Testing Email Service Configuration...');
  console.log('=====================================');
  
  // Check environment variables
  const requiredVars = ['SMTP_HOST', 'SMTP_PORT', 'SMTP_USER', 'SMTP_PASS'];
  const missingVars = requiredVars.filter(varName => !process.env[varName]);
  
  if (missingVars.length > 0) {
    console.error('‚ùå Missing required environment variables:', missingVars.join(', '));
    console.log('\nüìù Required environment variables:');
    console.log('   SMTP_HOST - SMTP server hostname');
    console.log('   SMTP_PORT - SMTP server port (usually 587 or 465)');
    console.log('   SMTP_USER - SMTP username (usually your email)');
    console.log('   SMTP_PASS - SMTP password (use app password for Gmail)');
    process.exit(1);
  }
  
  console.log('‚úÖ Environment variables present');
  console.log('üìß SMTP Host:', process.env.SMTP_HOST);
  console.log('üîå SMTP Port:', process.env.SMTP_PORT);
  console.log('üë§ SMTP User:', process.env.SMTP_USER);
  console.log('üîë SMTP Pass:', process.env.SMTP_PASS.substring(0, 4) + '*'.repeat(Math.max(0, process.env.SMTP_PASS.length - 4)));
  
  // Create transporter
  const transporter = nodemailer.createTransporter({
    host: process.env.SMTP_HOST,
    port: parseInt(process.env.SMTP_PORT),
    secure: process.env.SMTP_PORT === '465',
    auth: {
      user: process.env.SMTP_USER,
      pass: process.env.SMTP_PASS,
    },
  });
  
  try {
    // Test connection
    console.log('\nüîç Testing SMTP connection...');
    await transporter.verify();
    console.log('‚úÖ SMTP connection successful');
    
    // Send test email
    console.log('\nüì§ Sending test email...');
    const testEmail = {
      from: `"El-Mag Insurance Test" <${process.env.SMTP_USER}>`,
      to: process.env.SMTP_USER, // Send to self for testing
      subject: 'El-Mag Insurance - Email Service Test',
      html: `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
          <div style="background-color: #2563eb; color: white; padding: 20px; text-align: center;">
            <h1 style="margin: 0;">Email Service Test</h1>
            <p style="margin: 5px 0 0 0;">El-Mag Insurance Website</p>
          </div>
          <div style="padding: 20px; background-color: #f8fafc;">
            <h2 style="color: #1e40af;">‚úÖ Email Configuration Successful!</h2>
            <p>Your SMTP configuration is working correctly. The email service is ready for production use.</p>
            
            <div style="background-color: #dbeafe; padding: 15px; border-radius: 5px; margin: 20px 0;">
              <h3 style="color: #1e40af; margin-top: 0;">Configuration Details:</h3>
              <ul>
                <li><strong>SMTP Host:</strong> ${process.env.SMTP_HOST}</li>
                <li><strong>SMTP Port:</strong> ${process.env.SMTP_PORT}</li>
                <li><strong>SMTP User:</strong> ${process.env.SMTP_USER}</li>
                <li><strong>Test Time:</strong> ${new Date().toLocaleString()}</li>
              </ul>
            </div>
            
            <div style="background-color: #f0fdf4; padding: 15px; border-radius: 5px; border-left: 4px solid #10b981;">
              <h3 style="color: #047857; margin-top: 0;">Next Steps:</h3>
              <ol>
                <li>Update production environment variables</li>
                <li>Test contact form and quote request functionality</li>
                <li>Configure recipient email addresses</li>
                <li>Set up email monitoring and alerts</li>
              </ol>
            </div>
            
            <p>You can now process contact forms and quote requests successfully.</p>
            
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center;">
              <p style="margin: 0; color: #6b7280; font-size: 12px;">
                This test email was generated by the El-Mag Insurance email service test script
              </p>
            </div>
          </div>
        </div>
      `,
    };
    
    await transporter.sendMail(testEmail);
    console.log('‚úÖ Test email sent successfully');
    console.log('üì¨ Check your inbox:', process.env.SMTP_USER);
    
    // Test different email types
    console.log('\nüìã Testing email template functionality...');
    
    // Test contact form template
    console.log('üìß Testing contact form template...');
    const contactTestEmail = {
      from: `"El-Mag Insurance Contact Test" <${process.env.SMTP_USER}>`,
      to: process.env.SMTP_USER,
      subject: 'Contact Form Test - Test Subject',
      html: generateContactFormEmailTest(),
    };
    await transporter.sendMail(contactTestEmail);
    console.log('‚úÖ Contact form template test sent');
    
    // Test quote request template
    console.log('üìß Testing quote request template...');
    const quoteTestEmail = {
      from: `"El-Mag Insurance Quote Test" <${process.env.SMTP_USER}>`,
      to: process.env.SMTP_USER,
      subject: 'Medicare Quote Request Test - John Doe',
      html: generateQuoteRequestEmailTest(),
    };
    await transporter.sendMail(quoteTestEmail);
    console.log('‚úÖ Quote request template test sent');
    
    // Test confirmation email template
    console.log('üìß Testing confirmation email template...');
    const confirmationTestEmail = {
      from: `"El-Mag Insurance Confirmation Test" <${process.env.SMTP_USER}>`,
      to: process.env.SMTP_USER,
      subject: 'Thank you for contacting El-Mag Insurance (Test)',
      html: generateConfirmationEmailTest(),
    };
    await transporter.sendMail(confirmationTestEmail);
    console.log('‚úÖ Confirmation email template test sent');
    
    console.log('\nüéâ Email service is configured correctly and ready for production!');
    console.log('\nüìã Summary:');
    console.log('   ‚úÖ SMTP connection verified');
    console.log('   ‚úÖ Basic email sending functional');
    console.log('   ‚úÖ Contact form template tested');
    console.log('   ‚úÖ Quote request template tested');
    console.log('   ‚úÖ Confirmation email template tested');
    
    console.log('\nüîß Next steps:');
    console.log('   1. Check your email inbox for 4 test emails');
    console.log('   2. Verify templates render correctly');
    console.log('   3. Configure production environment variables');
    console.log('   4. Set up email recipient addresses for different form types');
    console.log('   5. Test the API endpoints: /api/contact and /api/quote');
    
  } catch (error) {
    console.error('‚ùå Email service test failed:', error.message);
    console.log('\nüîß Troubleshooting tips:');
    
    if (error.message.includes('auth') || error.message.includes('login')) {
      console.log('   üîë Authentication Issue:');
      console.log('      - Verify SMTP credentials are correct');
      console.log('      - For Gmail: Enable 2FA and use app-specific password');
      console.log('      - For Outlook: Enable SMTP AUTH in admin settings');
    }
    
    if (error.message.includes('timeout') || error.message.includes('ETIMEDOUT')) {
      console.log('   ‚è∞ Connection Timeout:');
      console.log('      - Check firewall settings and network connectivity');
      console.log('      - Try different ports: 587 (STARTTLS) or 465 (SSL)');
      console.log('      - Verify SMTP server hostname is correct');
    }
    
    if (error.message.includes('certificate') || error.message.includes('TLS')) {
      console.log('   üîí TLS/SSL Issue:');
      console.log('      - Try setting secure: false for port 587');
      console.log('      - Check if your provider requires specific TLS settings');
    }
    
    console.log('\nüìö Provider-specific guides:');
    console.log('   Gmail: https://support.google.com/accounts/answer/185833');
    console.log('   Outlook: https://docs.microsoft.com/en-us/exchange/clients-and-mobile-in-exchange-online/authenticated-client-smtp-submission');
    console.log('   SendGrid: https://sendgrid.com/docs/for-developers/sending-email/getting-started-smtp/');
    
    process.exit(1);
  }
}

function generateContactFormEmailTest() {
  return `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <div style="background-color: #2563eb; color: white; padding: 20px; text-align: center;">
        <h1 style="margin: 0;">New Contact Form Submission (TEST)</h1>
        <p style="margin: 5px 0 0 0;">El-Mag Insurance Website</p>
      </div>
      
      <div style="padding: 20px; background-color: #f8fafc;">
        <h2 style="color: #1e40af; margin-top: 0;">Contact Information</h2>
        <table style="width: 100%; border-collapse: collapse;">
          <tr>
            <td style="padding: 8px 0; font-weight: bold; width: 120px;">Name:</td>
            <td style="padding: 8px 0;">John Test User</td>
          </tr>
          <tr>
            <td style="padding: 8px 0; font-weight: bold;">Email:</td>
            <td style="padding: 8px 0;"><a href="mailto:test@example.com">test@example.com</a></td>
          </tr>
          <tr>
            <td style="padding: 8px 0; font-weight: bold;">Phone:</td>
            <td style="padding: 8px 0;"><a href="tel:555-123-4567">555-123-4567</a></td>
          </tr>
          <tr>
            <td style="padding: 8px 0; font-weight: bold;">ZIP Code:</td>
            <td style="padding: 8px 0;">12345</td>
          </tr>
          <tr>
            <td style="padding: 8px 0; font-weight: bold;">Subject:</td>
            <td style="padding: 8px 0;">Medicare Advantage Inquiry</td>
          </tr>
          <tr>
            <td style="padding: 8px 0; font-weight: bold;">Source:</td>
            <td style="padding: 8px 0;">Contact Form</td>
          </tr>
        </table>
        
        <h2 style="color: #1e40af;">Message</h2>
        <div style="background-color: white; padding: 15px; border-radius: 5px; border-left: 4px solid #2563eb;">
          I'm interested in learning more about Medicare Advantage plans available in my area. Please contact me to discuss my options.
        </div>
        
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 12px;">
          <p>This is a TEST email from the El-Mag Insurance contact form at ${new Date().toLocaleString()}</p>
        </div>
      </div>
    </div>
  `;
}

function generateQuoteRequestEmailTest() {
  return `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <div style="background-color: #059669; color: white; padding: 20px; text-align: center;">
        <h1 style="margin: 0;">New Medicare Quote Request (TEST)</h1>
        <p style="margin: 5px 0 0 0;">El-Mag Insurance Website</p>
      </div>
      
      <div style="padding: 20px; background-color: #f0fdf4;">
        <h2 style="color: #047857; margin-top: 0;">Customer Information</h2>
        <table style="width: 100%; border-collapse: collapse;">
          <tr>
            <td style="padding: 8px 0; font-weight: bold; width: 150px;">Name:</td>
            <td style="padding: 8px 0;">Jane Test Customer</td>
          </tr>
          <tr>
            <td style="padding: 8px 0; font-weight: bold;">Email:</td>
            <td style="padding: 8px 0;"><a href="mailto:jane@example.com">jane@example.com</a></td>
          </tr>
          <tr>
            <td style="padding: 8px 0; font-weight: bold;">Phone:</td>
            <td style="padding: 8px 0;"><a href="tel:555-987-6543">555-987-6543</a></td>
          </tr>
          <tr>
            <td style="padding: 8px 0; font-weight: bold;">ZIP Code:</td>
            <td style="padding: 8px 0;">90210</td>
          </tr>
          <tr>
            <td style="padding: 8px 0; font-weight: bold;">Date of Birth:</td>
            <td style="padding: 8px 0;">1958-06-15</td>
          </tr>
          <tr>
            <td style="padding: 8px 0; font-weight: bold;">Current Coverage:</td>
            <td style="padding: 8px 0;">Original Medicare</td>
          </tr>
        </table>
        
        <h2 style="color: #047857;">Coverage Interests</h2>
        <ul style="background-color: white; padding: 15px; border-radius: 5px; border-left: 4px solid #059669;">
          <li>Medicare Advantage</li>
          <li>Dental Coverage</li>
          <li>Vision Coverage</li>
          <li>Prescription Drug Coverage</li>
        </ul>
        
        <h2 style="color: #047857;">Contact Preferences</h2>
        <table style="width: 100%; border-collapse: collapse;">
          <tr>
            <td style="padding: 8px 0; font-weight: bold; width: 150px;">Preferred Method:</td>
            <td style="padding: 8px 0;">Phone</td>
          </tr>
          <tr>
            <td style="padding: 8px 0; font-weight: bold;">Preferred Time:</td>
            <td style="padding: 8px 0;">Morning (9 AM - 12 PM)</td>
          </tr>
        </table>
        
        <div style="margin-top: 20px; padding: 15px; background-color: #fef3c7; border-radius: 5px; border-left: 4px solid #f59e0b;">
          <p style="margin: 0; font-weight: bold; color: #92400e;">Action Required:</p>
          <p style="margin: 5px 0 0 0; color: #92400e;">This is a TEST quote request. Please follow up within 24 hours for best conversion rates.</p>
        </div>
        
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 12px;">
          <p>This TEST quote request was submitted at ${new Date().toLocaleString()}</p>
        </div>
      </div>
    </div>
  `;
}

function generateConfirmationEmailTest() {
  return `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <div style="background-color: #2563eb; color: white; padding: 20px; text-align: center;">
        <h1 style="margin: 0;">El-Mag Insurance (TEST)</h1>
        <p style="margin: 5px 0 0 0;">Medicare Advantage Specialists</p>
      </div>
      
      <div style="padding: 30px 20px; background-color: #f8fafc;">
        <h2 style="color: #1e40af; margin-top: 0;">Message Received (TEST)</h2>
        <p style="font-size: 16px; line-height: 1.6;">Dear Test User,</p>
        <p style="font-size: 16px; line-height: 1.6;">Thank you for contacting El-Mag Insurance. We have received your message and will respond as soon as possible, typically within one business day.</p>
        
        <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb; margin: 20px 0;">
          <h3 style="color: #1e40af; margin-top: 0;">Need immediate assistance?</h3>
          <p style="margin: 10px 0;">You can reach us directly:</p>
          <p style="margin: 10px 0;"><strong>Phone:</strong> <a href="tel:331-343-2584" style="color: #2563eb;">331-343-2584</a></p>
          <p style="margin: 10px 0;"><strong>Hours:</strong> Monday - Friday, 8 AM - 8 PM ET</p>
          <p style="margin: 10px 0;"><strong>Email:</strong> <a href="mailto:submissions@elmaginsurance.com" style="color: #2563eb;">submissions@elmaginsurance.com</a></p>
        </div>
        
        <p style="font-size: 16px; line-height: 1.6;">Thank you for choosing El-Mag Insurance for your Medicare needs. We look forward to helping you find the perfect coverage!</p>
        
        <p style="font-size: 16px; line-height: 1.6;">Best regards,<br>
        <strong>The El-Mag Insurance Team</strong></p>
        
        <div style="background-color: #fef3c7; padding: 15px; border-radius: 5px; border-left: 4px solid #f59e0b; margin-top: 20px;">
          <p style="margin: 0; font-weight: bold; color: #92400e;">TEST EMAIL NOTICE:</p>
          <p style="margin: 5px 0 0 0; color: #92400e;">This is a test confirmation email. In production, this would be sent to customers.</p>
        </div>
      </div>
      
      <div style="background-color: #374151; color: #d1d5db; padding: 20px; text-align: center; font-size: 12px;">
        <p style="margin: 0 0 10px 0;">El-Mag Insurance - Licensed Medicare Specialists</p>
        <p style="margin: 0;">This is a TEST email generated by the email service test script.</p>
      </div>
    </div>
  `;
}

// Run the test
testEmailService().catch(console.error);